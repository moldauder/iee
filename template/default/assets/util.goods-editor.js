KISSY.add("iee/util.goods-editor",function(e,t,i,d,a){function o(e){this.el=t.get(e),this.init()}var l={rmb:"￥",dollar:"$",pound:"£",deutsche:"€"};return e.augment(o,e.EventTarget,{init:function(){var e=this;e.modal=new d({cls:"goods-editor-modal",title:"编辑商品",body:'<div class="goods-item-list"><div class="goods-editor-item empty" data-event="addItem">add</div></div><div class="goods-item-editor"><form><div class="form-field"><div class="field-hd"><label for="goodsEditorTitle">标题</label></div><div class="field-bd"><input id="goodsEditorTitle" class="text" autocomplete="off" value="" data-validate=\'["require"]\' type="text" name="title" /></div></div><div class="form-field"><div class="field-hd"><label for="goodsEditorContent">描述</label></div><div class="field-bd"><textarea id="goodsEditorContent" class="text" type="text" name="content" data-validate=\'["require"]\' rows="6"></textarea></div></div><div class="form-field"><div class="field-hd"><label for="goodsEditorImg">图片</label></div><div class="field-bd"><input id="goodsEditorImg" class="text" autocomplete="off" value="" type="text" data-validate=\'["require"]\' name="img" placeholder="请上传1000x640的图片" /></div></div><div class="form-field"><div class="field-hd"><label for="goodsEditorLink">链接</label></div><div class="field-bd"><input id="goodsEditorLink" class="text" autocomplete="off" value="" type="text" data-validate=\'["require"]\' name="url" /></div></div><div class="form-field"><div class="field-hd"><label for="goodsEditorPrice">价格</label></div><div class="field-bd"><select name="currency"><option value="rmb">人民币</option><option value="dollar">美元</option></select><input id="goodsEditorPrice" class="text" autocomplete="off" value="" type="text" name="price" /></div></div><div class="form-field"><div class="field-hd"></div><div class="field-bd"><span tabindex="0" data-event="saveItem" class="btn">确定</span><span tabindex="0" data-event="closeItemEditor" class="btn">取消</span></div></div></form></div>',footer:'<span tabindex="0" class="btn btn-primary" data-event="save">保存</span><span tabindex="0" class="btn" data-event="cancel">关闭</span>'}),e.editorEl=e.modal.bodyEl,e.itemListEl=t.get("div.goods-item-list",e.editorEl),e.itemEditorEl=t.get("div.goods-item-editor",e.editorEl),e.itemEditorFormEl=t.get("form",e.itemEditorEl),e.checkObj=new a(e.itemEditorFormEl),i.on(e.modal.el,"click",function(t){e.dispatchEvent(t.target,t)}),e.el.innerHTML='<div class="goods-editor-preview"></div><a class="btn goods-editor-trigger">编辑商品</a>',e.previewEl=t.get("div.goods-editor-preview",e.el),i.on(t.get("a.goods-editor-trigger",this.el),"click",function(t){t.halt(),e.closeItemEditor(),e.modal.show()});var o=t.attr(this.el,"data-var");o&&e.fill(window[o]||[])},cancel:function(){this.modal.hide()},save:function(){var i=this,d="";e.each(t.children(i.itemListEl),function(e,t){var a=i.getItemData(e);a&&(d+='<a href="'+a.url+'" target="_blank"><img width="120" src="'+a.img+'" title="'+a.title+'" /></a><input type="hidden" name="goodsitem['+t+'][url]" value="'+a.url+'" /><input type="hidden" name="goodsitem['+t+'][img]" value="'+a.img+'" /><input type="hidden" name="goodsitem['+t+'][title]" value="'+a.title+'" /><input type="hidden" name="goodsitem['+t+'][currency]" value="'+a.currency+'" /><input type="hidden" name="goodsitem['+t+'][price]" value="'+a.price+'" /><textarea name="goodsitem['+t+'][content]">'+a.content+"</textarea>")}),i.previewEl.innerHTML=d,i.cancel()},dispatchEvent:function(e,i){var d=t.attr(e,"data-event");d&&i.halt(),this[d]&&this[d](e)},addItem:function(e){this.activeItemEl=e,this.openItemEditor()},openItemEditor:function(i){if(e.isPlainObject(i)){var d=this.itemEditorFormEl.elements;for(var a in i)t.val(d[a],i[a])}else this.itemEditorFormEl.reset();t.addClass(this.editorEl,"goods-editor-mode-edit")},closeItemEditor:function(){t.removeClass(this.editorEl,"goods-editor-mode-edit")},saveItem:function(){var i=this;i.checkObj.validate(function(d){if(d){var a=i.itemEditorFormEl.elements;i.activeItemEl.innerHTML=i.renderItemData({title:e.trim(t.val(a.title)),content:e.trim(t.val(a.content)),url:e.trim(t.val(a.url)),img:e.trim(t.val(a.img)),currency:t.val(a.currency),price:e.trim(t.val(a.price))}),t.removeClass(i.activeItemEl,"empty"),i.closeItemEditor(),i.itemEditorFormEl.reset(),t.children(i.itemListEl,".empty").length||(t.removeAttr(i.activeItemEl,"data-event"),t.prepend(t.create('<div class="goods-editor-item empty" data-event="addItem">add</div>'),i.itemListEl))}})},renderItemData:function(e){var t=e.currency;return'<a target="_blank" class="item" href="'+e.url+'" data-currency="'+t+'"><img src="'+e.img+'" /><div class="mask"></div><div class="extra"><div class="title">'+e.title+'</div><div class="price"><span class="unit '+t+'">'+l[t]+'</span><span class="pricestr">'+e.price+'</span></div><div class="content">'+e.content+'</div></div></a><div class="action"><span data-event="prevItem">前移</span><span data-event="nextItem">后移</span><span data-event="modifyItem">修改</span><span data-event="removeItem">删除</span></div>'},fill:function(t){var i=this,d="";e.each(t,function(e){d+='<div class="goods-editor-item">'+i.renderItemData(e)+"</div>"}),i.itemListEl.innerHTML='<div class="goods-editor-item empty" data-event="addItem">add</div>'+d,i.save()},modifyItem:function(e){var i=t.parent(e,"div.goods-editor-item");this.activeItemEl=i,this.openItemEditor(this.getItemData(i))},getItemData:function(e){var i=t.get("a.item",e);return t.hasClass(e,"empty")?null:{url:t.attr(i,"href"),img:t.attr(t.get("img",i),"src"),title:t.html(t.get("div.title",i)),content:t.html(t.get("div.content",i)),currency:t.attr(i,"data-currency"),price:t.html(t.get("span.pricestr",i))}},removeItem:function(e){t.remove(t.parent(e,"div.goods-editor-item"))},prevItem:function(e){var i=t.parent(e,"div.goods-editor-item"),d=t.prev(i);d?t.insertBefore(i,d):t.append(i,this.itemListEl)},nextItem:function(e){var i=t.parent(e,"div.goods-editor-item"),d=t.next(i);d?t.insertAfter(i,d):t.prepend(i,this.itemListEl)}}),o},{requires:["dom","event","iee/util.modal","iee/util.validation","iee/util.goods-editor.css","iee/util.modal.css"]});