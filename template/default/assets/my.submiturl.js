KISSY.add("iee/my.submiturl",function(a,t,i,s,e){var r={};return r.init=function(i){var e=this;e.isLoading||(e.isLoading=!0,App.Loading.show("正在加载"),s.get("/my/tmpl?name=submiturl",function(s){App.Panel.add("submiturl",s),App.Loading.hide();var r=t.get("#submiturl");e.eles={root:r,grid:t.query("div.grid",r),pager:t.query("div.pager",r),form:t.query("form.query-form",r)},e.initQueryForm(),e.list(),App.on("createNewPost",function(a){a.isFromSubmit&&(e.hasSubmiturlChange=!0)}),e.init=function(t){e.hasSubmiturlChange&&(e.list(),e.hasSubmiturlChange=!1),App.Panel["switch"]("submiturl"),a.isFunction(t)&&t()},e.init(i)}))},r.form2Map=function(){return a.unparam(s.serialize(this.eles.form[0]))},r.initQueryForm=function(){a.each(this.eles.form,function(a){i.on(a,"submit",function(a){a.halt(),r.list(r.form2Map())})})},r.list=function(t,i){App.Loading.show("读取submit列表中..."),t=a.merge(t,{num:12,action:"submiturl"}),s.get("/my/query?"+a.param(t),function(t){r.renderList(t),r.renderPager(t),a.isFunction(i)&&i(t),App.Panel.updateUI(),App.Loading.hide()},"json")},r.renderPager=function(a){var i="",s=a.list,e=a.size;if(e>1){var r=s[0].id,n=s[e-1].id;i+='<div class="pagination">',i+=a.prev?'<a title=上一页 href="/my/query?action=submiturl&&page=prev&id='+r+'" class="pager-prev" data-act="my.submiturl/prev:'+r+'"></a>':'<span class="pager-prev"></span>',i+=a.next?'<a title=下一页 href="/my/query?action=submiturl&page=next&id='+n+'" class="pager-next" data-act="my.submiturl/next:'+n+'"></a>':'<span class="pager-next"></span>',i+="</div>"}t.html(this.eles.pager,i)},r.renderList=function(i){var s=(r.statusMap,"");i.size?a.each(i.list,function(a){var t=a.id;s+='<div class="grid-item">',s+='<div class="title"><a class="title" target="_blank" href="'+a.url+'">'+(a.title||a.url)+"</a></div>";var i=[];a.nick&&i.push('<div class="column"><span>推荐人:</span><p>'+a.nick+"</p></div>"),a.weibo&&i.push('<div class="column"><span>微博:</span><p>'+a.weibo+"</p></div>"),a.remark&&i.push('<div class="column"><span>理由:</span><p class="remark">'+a.remark+"</p></div>"),i.length&&(s+='<div title="'+(a.remark?"推荐理由："+a.remark:"")+'" class="meta">'+i.join("")+"</div>"),s+='<div class="action">',"s"===a.status?(s+='将状态置为:<a class="btn" href="/my/status?action=submiturl&field=p&id='+t+'" data-act="my.submiturl/status">通过</a>',s+='<a class="btn" href="/my/postnew" data-act="my.submiturl/compose:'+t+'">发表文章</a>',s+='<a class="btn" href="/my/status?action=submiturl&field=remove&id='+t+'" data-act="my.submiturl/status">删除</a>'):(s+='<span class="label label-success">已通过</span><label>处理人:'+a.userNick+"</label>",s+=a.postid>0?'<a class="label label-info" href="/'+a.postid+'" target="_blank">关联文章</a>':'<a class="btn" href="/my/postnew" data-act="my.submiturl/compose:'+t+'">发表文章</a>'),s+="</div>",s+="</div>"}):s='<div><div class="alert">当前没有submit</div></div>',t.html(this.eles.grid,s)},r.pager=function(a,t,i){var s=this.form2Map();s.page=i,s.id=t,this.list(s)},r.prev=function(a,t){this.pager(a,t,"prev")},r.next=function(a,t){this.pager(a,t,"next")},r.compose=function(i,s){a.use("iee/postcompose",function(a,e){var r=t.parent(i,"div.grid-item");e.edit({outer_url:t.attr(t.get("a.title",r),"href"),content:"<p>"+(t.html(t.get("p.remark",r))||"")+"</p>",params:"submiturl="+s})})},r.status=function(i){t.hasClass(i,"async")||(t.addClass(i,"async"),s.get(t.attr(i,"href"),function(s){if(t.removeClass(i,"async"),s.success){var e=s.status;"p"===e?t.parent(i,"div.action").innerHTML='<span class="label label-success">已通过</span><label>处理人:'+s.userNick+"</label>":"remove"===e&&a.one(t.parent(i,"div.grid-item")).fadeOut()}},"json"))},r},{requires:["dom","event","ajax","iee/my.modal"]});