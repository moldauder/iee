KISSY.add("iee/util.validation",function(S,DOM,Event,JSON){function Validation(el,config){this.el=DOM.get(el);this.config=S.merge({when:"blur keyup"},config);this.init()}S.augment(Validation,S.EventTarget,{init:function(){var self=this;S.each(self.el.elements,function(element){var validate=DOM.attr(element,"data-validate");if(!validate){return}try{var rule=JSON.parse(validate);if(S.isArray(rule)){rule=S.isArray(rule[0])?rule:[rule]}DOM.data(element,"rule",rule);Event.on(element,self.config.when,function(){self.doCheck(element)})}catch(e){}})},validate:function(then){var self=this;var ticket=self.el.elements.length;var isOk=true;then=S.isFunction(then)?then:function(){};S.each(self.el.elements,function(element){self.doCheck(element,function(isPass){if(!isPass){isOk=false}ticket--;if(0===ticket){then(isOk)}})})},doCheck:function(element,then){var self=this;then=S.isFunction(then)?then:function(){};self.clearErr(element);var rule=DOM.data(element,"rule");if(!rule){return then(true)}var ticket=rule.length;var isOk=true;S.each(rule,function(config){Validation.Rule.check(element,function(ret){ticket--;if(true!==ret){self.addErr(element,ret);isOk=false}if(0===ticket){then(isOk)}},config)})},addErr:function(element,msg,type){var msgEl=DOM.create("<div></div>");msgEl.innerHTML="<p>"+msg+"</p>";msgEl.className="field-formtip "+(type||"err");DOM.parent(element,"div.field-bd").appendChild(msgEl)},clearErr:function(element){DOM.remove(DOM.query("div.field-formtip",DOM.parent(element,"div.field-bd")))}});Validation.Rule={add:function(ruleName,checker){var rules=this.rules||{};rules[ruleName]=checker;this.rules=rules},check:function(element,then,config){var ruleName=config[0];var rules=this.rules;if(ruleName in rules){rules[ruleName].apply({},[S.trim(DOM.val(element)),then].concat(config.slice(1)))}}};Validation.Rule.add("require",function(value,then,msg){value?then(true):then(msg||"此项必须填写")});Validation.Rule.add("equal",function(value,then,selector,msg){return value===S.trim(DOM.val("#"+selector))?then(true):then(msg||"两次输入的值不一致")});return Validation},{requires:["dom","event","json"]});