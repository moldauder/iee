KISSY.add("iee/my.postcompose",function(e,t,i,s,o,r,n){var a={};return a.init=function(){this.formEl=t.get("#postComposeForm"),this.checkObj=new r(this.formEl),n.init(),this.imgPreviewer(this.formEl.elements.img),t.get("#wecontent")&&(this.we=new tinymce.Editor("wecontent",{menubar:!1,statusbar:!1,plugins:"image textcolor colorpicker",toolbar:"bold, italic, underline, strikethrough, alignleft, aligncenter, alignright, alignjustify, forecolor, backcolor, bullist, numlist, outdent, indent, blockquote, undo, redo, removeformat, image"},tinymce.EditorManager),this.we.render())},a.publish=function(){this.submit("publish")},a.save=function(){this.submit("draft")},a.submit=function(e){var t=this;this.formEl.elements.operate.value=e,this.we&&(this.formEl.elements.wecontent.value=this.we.getContent());var i=new o.ProgressBar;i.show(),t.checkObj.validate(function(e){e&&s({url:"/item/save",type:"post",form:t.formEl,dataType:"json",success:function(e){t.submitSuccess(e),i.hide()},error:function(){t.submitError(),i.hide()}})})},a.submitSuccess=function(e){var t=this.getFeedbackModal(),i=this.formEl.elements,s="publish"===i.operate.value;if(i.id.value=e.id,e.success){t.setBody("文章<strong>"+i.title.value+"</strong>"+(s?"保存并发布":"保存草稿")+"成功");var o=[{title:"查看文章列表",href:"/item/all",target:"_self"},{title:"继续编辑",act:"my.postcompose/closeFeedback"},{title:"撰写新文章",href:"/item/create",target:"_self"}];s&&o.push({title:"查看文章",href:"/"+("0"!==e.sid?e.sid:e.id)}),t.setFooter(o),t.show()}else this.submitError(e)},a.submitError=function(e){var t=this.getFeedbackModal(),i="publish"===this.formEl.elements.operate.value;e=e||{},t.setBody('<div class="error">'+((i?"保存发布文章":"保存草稿")+"失败")+(e.msg?"，<strong>"+e.msg+"</strong>":"")+"</div>"),t.setFooter([{title:"查看文章列表",href:"/item/all",target:"_self"},{title:"返回编辑",act:"my.postcompose/closeFeedback",primary:!0}]),t.show()},a.getFeedbackModal=function(){return this.feedbackModal||(this.feedbackModal=new o({title:t.text("#content h2"),cls:"postcompose-modal"})),this.feedbackModal},a.closeFeedback=function(){var e=this.feedbackModal;e&&e.hide()},a.cleartaoke=function(e){var i=this.formEl;s({type:"post",url:"/item/cleartaoke",data:{id:i.elements.id.value},success:function(i){var s=t.next(e,"span.tip");s||(s=t.create('<span class="tip"></span>'),t.insertAfter(s,e)),s.innerHTML=i.success?"清除成功":"清除失败"}})},a.imgPreviewer=function(s){var o=t.create('<div class="sideinfo"><span></span><s class="arrow"></s></div>'),r=t.get("span",o);t.parent(s,"div.form-field").appendChild(o);var n,a=function(){var t=e.trim(s.value);if(t){var i=new Image;i.onerror=function(){r.innerHTML="不是有效的图片"},i.onload=function(){r.innerHTML='<a target="_blank" href="'+t+'"><img src="'+t+'" width="120" /></a>'},r.innerHTML="加载中...",o.style.visibility="visible",i.src=t}else o.style.visibility="hidden"};i.on(s,"valuechange",function(){n&&n.cancel(),n=e.later(a,100)}),a()},a},{requires:["dom","event","ajax","iee/util.modal","iee/util.validation","iee/my.category"]});