KISSY.add("iee/my.postcompose",function(e,t,i,s,r,a,o){var n={};return n.init=function(){this.formEl=t.get("#postComposeForm"),this.checkObj=new a(this.formEl),o.init(),this.imgPreviewer(this.formEl.elements.img),t.get("#wecontent")&&(this.we=new tinymce.Editor("wecontent",{menubar:!1,statusbar:!1},tinymce.EditorManager),this.we.render())},n.publish=function(){this.submit("publish")},n.save=function(){this.submit("draft")},n.submit=function(e){var t=this;this.formEl.elements.operate.value=e,this.we&&(this.formEl.elements.wecontent.value=this.we.getContent());var i=new r.ProgressBar;i.show(),t.checkObj.validate(function(e){e&&s({url:"/item/save",type:"post",form:t.formEl,dataType:"json",success:function(e){t.submitSuccess(e),i.hide()},error:function(){t.submitError(),i.hide()}})})},n.submitSuccess=function(e){var t=this.getFeedbackModal(),i=this.formEl.elements,s="publish"===i.operate.value;if(i.id.value=e.id,e.success){t.setBody("文章<strong>"+i.title.value+"</strong>"+(s?"保存并发布":"保存草稿")+"成功");var r=[{title:"查看文章列表",href:"/item/all",target:"_self"},{title:"继续编辑",act:"my.postcompose/closeFeedback"},{title:"撰写新文章",href:"/item/create",target:"_self"}];s&&r.push({title:"查看文章",href:"/"+("0"!==e.sid?e.sid:e.id)}),t.setFooter(r),t.show()}else this.submitError(e)},n.submitError=function(e){var t=this.getFeedbackModal(),i="publish"===this.formEl.elements.operate.value;e=e||{},t.setBody('<div class="error">'+((i?"保存发布文章":"保存草稿")+"失败")+(e.msg?"，<strong>"+e.msg+"</strong>":"")+"</div>"),t.setFooter([{title:"查看文章列表",href:"/item/all",target:"_self"},{title:"返回编辑",act:"my.postcompose/closeFeedback",primary:!0}]),t.show()},n.getFeedbackModal=function(){return this.feedbackModal||(this.feedbackModal=new r({title:t.text("#content h2"),cls:"postcompose-modal"})),this.feedbackModal},n.closeFeedback=function(){var e=this.feedbackModal;e&&e.hide()},n.cleartaoke=function(e){var i=this.formEl;s({type:"post",url:"/item/cleartaoke",data:{id:i.elements.id.value},success:function(i){var s=t.next(e,"span.tip");s||(s=t.create('<span class="tip"></span>'),t.insertAfter(s,e)),s.innerHTML=i.success?"清除成功":"清除失败"}})},n.imgPreviewer=function(s){var r=t.create('<div class="sideinfo"><span></span><s class="arrow"></s></div>'),a=t.get("span",r);t.parent(s,"div.form-field").appendChild(r);var o,n=function(){var t=e.trim(s.value);if(t){var i=new Image;i.onerror=function(){a.innerHTML="不是有效的图片"},i.onload=function(){a.innerHTML='<a target="_blank" href="'+t+'"><img src="'+t+'" width="120" /></a>'},a.innerHTML="加载中...",r.style.visibility="visible",i.src=t}else r.style.visibility="hidden"};i.on(s,"valuechange",function(){o&&o.cancel(),o=e.later(n,100)}),n()},n},{requires:["dom","event","ajax","iee/util.modal","iee/util.validation","iee/my.category"]});