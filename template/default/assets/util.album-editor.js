KISSY.add("iee/util.album-editor",function(t,e,i,a,l,d){function n(t){this.el=e.get(t),this.init()}return t.augment(n,t.EventTarget,{init:function(){var t=this;t.modal=new a({cls:"album-editor-modal",title:"编辑专辑商品",body:'<div class="album-item-list"><div class="album-editor-item empty" data-event="addItem">add</div></div><div class="album-item-editor"><form><div class="form-field"><div class="field-hd"><label for="albumEditorTitle">标题</label></div><div class="field-bd"><input id="albumEditorTitle" class="text" autocomplete="off" value="" data-validate=\'["require"]\' type="text" name="title" /></div></div><div class="form-field"><div class="field-hd"><label for="albumEditorContent">描述</label></div><div class="field-bd"><textarea id="albumEditorContent" class="text" type="text" name="content" data-validate=\'["require"]\'></textarea></div></div><div class="form-field"><div class="field-hd"><label for="albumEditorImg">图片</label></div><div class="field-bd"><input id="albumEditorImg" class="text" autocomplete="off" value="" type="text" data-validate=\'["require"]\' name="img" /></div></div><div class="form-field"><div class="field-hd"><label for="albumEditorLink">链接</label></div><div class="field-bd"><input id="albumEditorLink" class="text" autocomplete="off" value="" type="text" data-validate=\'["require"]\' name="outer_url" /></div></div><div class="form-field"><div class="field-hd"></div><div class="field-bd"><span tabindex="0" data-event="saveItem" class="btn">确定</span><span tabindex="0" data-event="closeItemEditor" class="btn">取消</span></div></div></form></div>',footer:'<span tabindex="0" class="btn btn-primary" data-event="save">保存</span><span tabindex="0" class="btn" data-event="cancel">关闭</span>'}),t.editorEl=t.modal.bodyEl,t.itemListEl=e.get("div.album-item-list",t.editorEl),t.itemEditorEl=e.get("div.album-item-editor",t.editorEl),t.itemEditorFormEl=e.get("form",t.itemEditorEl),t.checkObj=new l(t.itemEditorFormEl),t.suggestObj=new d("#albumEditorTitle",{cls:"suggest-albumitem",url:"/item/fuzzy",render:function(t,e,i){var a=t.title.replace(new RegExp("("+e+")","ig"),'<span class="highlight">$1</span>');return'<div class="title" data-link="'+(t.outer_url||"")+'" data-img="'+t.img+'">'+a+'</div><div class="content">'+t.content+"</div>"}}),t.suggestObj.on("select",function(t){var i=t.element,a=e.get("div.title",i);e.val("#albumEditorTitle",e.text(a)),e.val("#albumEditorImg",e.attr(a,"data-img")),e.val("#albumEditorLink",e.attr(a,"data-link")),e.val("#albumEditorContent",e.html(e.get("div.content",i)))}),i.on(t.modal.el,"click",function(e){t.dispatchEvent(e.target,e)}),t.el.innerHTML='<div class="album-editor-preview"></div><a class="btn album-editor-trigger">编辑专辑商品</a>',t.previewEl=e.get("div.album-editor-preview",t.el),i.on(e.get("a.album-editor-trigger",this.el),"click",function(e){e.halt(),t.closeItemEditor(),t.modal.show()});var n=e.attr(this.el,"data-var");n&&t.fill(window[n]||[])},cancel:function(){this.modal.hide()},save:function(){var i=this,a="";t.each(e.children(i.itemListEl),function(t,e){var l=i.getItemData(t);l&&(a+='<a href="'+l.outer_url+'" target="_blank"><img width="120" src="'+l.img+'" title="'+l.title+'" /></a><input type="hidden" name="albumitem['+e+'][outer_url]" value="'+l.outer_url+'" /><input type="hidden" name="albumitem['+e+'][img]" value="'+l.img+'" /><input type="hidden" name="albumitem['+e+'][title]" value="'+l.title+'" /><textarea name="albumitem['+e+'][content]">'+l.content+"</textarea>")}),i.previewEl.innerHTML=a,i.cancel()},dispatchEvent:function(t,i){var a=e.attr(t,"data-event");a&&i.halt(),this[a]&&this[a](t)},addItem:function(t){this.activeItemEl=t,this.openItemEditor()},openItemEditor:function(i){if(t.isPlainObject(i)){var a=this.itemEditorFormEl.elements;for(var l in i)e.val(a[l],i[l])}else this.itemEditorFormEl.reset();e.addClass(this.editorEl,"album-editor-mode-edit")},closeItemEditor:function(){e.removeClass(this.editorEl,"album-editor-mode-edit")},saveItem:function(){var i=this;i.checkObj.validate(function(a){if(a){var l=i.itemEditorFormEl.elements;i.activeItemEl.innerHTML=i.renderItemData({title:t.trim(e.val(l.title)),content:t.trim(e.val(l.content)),outer_url:t.trim(e.val(l.outer_url)),img:t.trim(e.val(l.img))}),e.removeClass(i.activeItemEl,"empty"),i.closeItemEditor(),i.itemEditorFormEl.reset(),e.children(i.itemListEl,".empty").length||(e.removeAttr(i.activeItemEl,"data-event"),e.prepend(e.create('<div class="album-editor-item empty" data-event="addItem">add</div>'),i.itemListEl))}})},renderItemData:function(t){return'<a target="_blank" class="item" href="'+t.outer_url+'"><img src="'+t.img+'" /><div class="mask"></div><div class="extra"><div class="title">'+t.title+'</div><div class="desc">'+t.content+'</div></div></a><div class="action"><span data-event="prevItem">前移</span><span data-event="nextItem">后移</span><span data-event="modifyItem">修改</span><span data-event="removeItem">删除</span></div>'},fill:function(e){var i=this,a="";t.each(e,function(t){a+='<div class="album-editor-item">'+i.renderItemData(t)+"</div>"}),i.itemListEl.innerHTML='<div class="album-editor-item empty" data-event="addItem">add</div>'+a,i.save()},modifyItem:function(t){var i=e.parent(t,"div.album-editor-item");this.activeItemEl=i,this.openItemEditor(this.getItemData(i))},getItemData:function(t){return e.hasClass(t,"empty")?null:{outer_url:e.attr(e.get("a.item",t),"href"),img:e.attr(e.get("img",t),"src"),title:e.html(e.get("div.title",t)),content:e.html(e.get("div.desc",t))}},removeItem:function(t){e.remove(e.parent(t,"div.album-editor-item"))},prevItem:function(t){var i=e.parent(t,"div.album-editor-item"),a=e.prev(i);a?e.insertBefore(i,a):e.append(i,this.itemListEl)},nextItem:function(t){var i=e.parent(t,"div.album-editor-item"),a=e.next(i);a?e.insertAfter(i,a):e.prepend(i,this.itemListEl)}}),n},{requires:["dom","event","iee/util.modal","iee/util.validation","iee/util.suggest","iee/util.album-editor.css","iee/util.modal.css"]});